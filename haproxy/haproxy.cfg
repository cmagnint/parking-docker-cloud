global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Frontend principal - Puerto 8282 del host mapea a puerto 8181 interno
frontend parking_frontend
    bind *:8181
    mode http
    option forwardfor
    
    # Headers de seguridad
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header X-Permitted-Cross-Domain-Policies none
    
    # CORS headers para Flutter app
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    http-response set-header Access-Control-Allow-Headers "Origin, Accept, Content-Type, X-Requested-With, Authorization, X-Auth-Token"
    http-response set-header Access-Control-Allow-Credentials "true"
    
    # Manejar preflight requests de CORS
    acl is_options method OPTIONS
    http-request return status 200 content-type "text/plain" string "OK" if is_options
    
    default_backend parking_backend

# Backend - Django con Gunicorn
backend parking_backend
    mode http
    balance roundrobin
    option httpchk GET /parking_app_admin/login/
    http-check expect status 200
    
    # Configuraciones de conexión
    option httpclose
    option forwardfor
    
    # Servidor Django
    server django1 backend:8000 check inter 3000 rise 2 fall 3 maxconn 32

# Panel de estadísticas - Puerto 8505 del host mapea a puerto 8404 interno  
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats admin if TRUE
    stats auth admin:parking123
    
    # Headers de seguridad para stats
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
